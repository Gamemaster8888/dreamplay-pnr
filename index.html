<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DreamPlay Personal Natural Resources (PNR) Digital Miner</title>
  <link rel="stylesheet" href="/assets/styles.css" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; margin:0; padding:16px; }
    h1 { margin:0; }
    .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    .card { border:1px solid #ddd; border-radius:10px; padding:16px; margin-top:1rem; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
    button { padding:10px 16px; border:none; border-radius:8px; font-weight:600; cursor:pointer; }
    .small { opacity:.85; font-size:.9rem; }
    .muted { opacity:.7; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <header class="row" style="justify-content:space-between; border-bottom:1px solid #ddd; padding-bottom:.5rem;">
    <div class="row">
      <img src="/assets/dreamplay-logo.png" alt="DreamPlay logo" style="height:48px;border-radius:8px" onerror="this.style.display='none'">
      <div>
        <h1>DreamPlay Personal Natural Resources (PNR) Digital Miner</h1>
        <div class="muted">Your sponsor must be an Anchor or someone who has launched via the DreamPlay Token Factory.</div>
      </div>
    </div>
    <a href="/dgnn/">Go to DGNN →</a>
  </header>

  <main>
    <section class="card">
      <div class="row">
        <button id="connectBtn" style="background:#6b46c1;color:#fff;">Connect with MetaMask</button>
        <span id="connStatus" class="small">Not connected</span>
      </div>
      <div id="pointsToday" class="small muted"></div>
    </section>

    <section class="card">
      <h2>Actions</h2>
      <div class="row" style="gap:.5rem; flex-wrap:wrap">
        <select id="actionSelect">
          <option value="RECRUIT_MEMBER">Recruit a New Member (+20 pts)</option>
          <option value="COACH_MEMBER">Coach a New Member (+15 pts)</option>
          <option value="CREATE_CONTENT">Create Content (+10 pts)</option>
          <option value="SHARE_CONTENT">Share Content (+5 pts)</option>
          <option value="VERIFY_ID">Verify ID (+15 pts)</option>
          <option value="QUALITY_CONTROL">Quality Control (+5 pts)</option>
          <option value="FINLIT_LESSON">Financial Literacy Lesson (+15 pts)</option>
          <option value="REPORTER">Reporter (+15 pts)</option>
          <option value="DREAMCASTER">DreamCaster (+15 pts)</option>
          <option value="VOTE">Vote (+10 pts)</option>
          <option value="BELIEF_CHAIN">Join the Belief Chain (+20 pts)</option>
        </select>
        <input id="sponsorInput" placeholder="Optional: sponsor address" style="flex:1;min-width:240px;padding:8px;border:1px solid #ccc;border-radius:8px;">
        <button id="logBtn" style="background:#4CAF50;color:#fff;">Log Action</button>
      </div>
      <div id="actorStatus" class="small"></div>
    </section>

    <section class="card">
      <h2>Daily Video</h2>
      <iframe id="video" width="560" height="315"
        src="https://www.youtube.com/embed/olQrCfkvbGw?rel=0&enablejsapi=1&playsinline=1"
        frameborder="0" allowfullscreen></iframe>
      <div class="row" style="margin-top:.5rem">
        <button id="claimBtn" disabled style="background:#2196F3;color:#fff;">Claim Daily Points</button>
        <span id="claimStatus" class="small">Watch at least <b>60s and 50%</b> to enable claim.</span>
        <span id="claimDebug" class="small muted"></span>
      </div>
    </section>

    <section class="card">
      <h2>Verifier</h2>
      <div class="row">
        <button id="checkFunctions">Check Functions</button>
        <button id="getNonce">Get Nonce</button>
        <span id="verifyStatus" class="small"></span>
      </div>
    </section>

    <section class="card">
      <h2>Leaderboard</h2>
      <div class="row">
        <button id="refreshLbBtn">Refresh</button>
        <span id="lbStatus" class="small"></span><span id="lbUpdated" class="small"></span>
      </div>
      <table style="width:100%;border-collapse:collapse;margin-top:.5rem">
        <thead><tr><th>#</th><th>Address</th><th>Points</th></tr></thead>
        <tbody id="lbTableBody"><tr><td>—</td><td>—</td><td>—</td></tr></tbody>
      </table>
    </section>
  </main>

  <script type="module">
    import { App } from '/assets/app.js';
    const $ = s => document.querySelector(s);

    const connectBtn = $('#connectBtn');
    const connStatus = $('#connStatus');
    const pointsToday = $('#pointsToday');
    const logBtn = $('#logBtn');
    const actorStatus = $('#actorStatus');
    const claimBtn = $('#claimBtn');
    const claimStatus = $('#claimStatus');
    const claimDebug = $('#claimDebug');

    async function refreshPointsToday() {
      try {
        const total = await App.getTodayTotal();
        if (typeof total === 'number')
          pointsToday.textContent = `Points today: ${total}/100`;
      } catch {}
    }

    // ---- Connect ----
    connectBtn.onclick = async () => {
      try {
        await App.connectMetaMask(connStatus);
        await refreshPointsToday();
      } catch(e){ alert(e.message); }
    };

    // ---- Log action ----
    logBtn.onclick = async () => {
      const addr = App.state.address || localStorage.getItem('walletAddress');
      if (!addr) return alert('Connect wallet first');
      const pointsMap = {RECRUIT_MEMBER:20,COACH_MEMBER:15,CREATE_CONTENT:10,SHARE_CONTENT:5,VERIFY_ID:15,QUALITY_CONTROL:5,FINLIT_LESSON:15,REPORTER:15,DREAMCASTER:15,VOTE:10,BELIEF_CHAIN:20};
      const id = $('#actionSelect').value;
      const sponsor = $('#sponsorInput').value.trim();
      const pts = pointsMap[id]||0;
      actorStatus.textContent = 'Logging…';
      try {
        const res = await App.logAction(id, pts, sponsor);
        const maxed = res.capped || (res.dayTotal >= 100);
        if (res.awarded > 0) {
          actorStatus.textContent = `Logged ${id} (+${res.awarded}) • Total ${res.dayTotal}`;
          window.confetti?.({spread:60,particleCount:80,origin:{y:0.7}});
        } else if (maxed) {
          actorStatus.textContent = 'Max Daily Pts Reached (100).';
        } else {
          actorStatus.textContent = 'No points awarded.';
        }
        await refreshPointsToday();
        $('#refreshLbBtn').click();
      } catch(e){ actorStatus.textContent='Log failed'; alert(e.message); }
    };

    // ---- YouTube gating ----
    let player, watched=0, duration=0, playing=false, apiReady=false, fallbackStarted=false;
    window.onYouTubeIframeAPIReady=function(){
      apiReady=true; claimDebug.textContent='YT API ready';
      player=new YT.Player('video',{events:{
        onReady:e=>{duration=e.target.getDuration();},
        onStateChange:e=>{
          if(e.data===YT.PlayerState.PLAYING){playing=true;}
          else if(playing){playing=false;updateGate();}
        }
      }});
    };
    setInterval(()=>{ if(playing){watched+=0.5;updateGate();}},500);
    function eligibleNow(){
      if(apiReady&&player){
        let pct=0; try{pct=player.getCurrentTime()/duration;}catch{}
        return watched>=60&&pct>=0.5;
      }
      return watched>=60;
    }
    function updateGate(){
      const ok=eligibleNow();
      claimBtn.disabled=!ok;
      let pct=0;try{pct=player.getCurrentTime()/duration;}catch{}
      claimStatus.textContent=ok?'Eligible to claim ✅':`Watch at least 60s and 50% — watched ${Math.floor(watched)}s (${Math.floor(pct*100)}%)`;
    }
    if(!apiReady&&!fallbackStarted){fallbackStarted=true;setInterval(()=>{watched+=1;updateGate();},1000);}

    // ---- Claim ----
    claimBtn.onclick=async()=>{
      if(!eligibleNow())return;
      claimBtn.disabled=true;
      claimStatus.textContent='Claiming…';
      try{
        const resp=await App.postClaim('daily-video',{watchedSeconds:Math.floor(watched)});
        if(resp.alreadyClaimed){
          const mins=Math.ceil((resp.nextEligibleMs||0)/60000);
          claimStatus.textContent=`Already claimed — try again in ~${mins} min.`;
        }else if(resp.capped||(resp.dayTotal>=100)){
          claimStatus.textContent='Max Daily Pts Reached (100).';
        }else if(resp.pointsAwarded>0){
          claimStatus.textContent=`Claimed! +${resp.pointsAwarded} (today ${resp.dayTotal})`;
          window.confetti?.({spread:70,particleCount:120,origin:{y:0.6}});
          await refreshPointsToday();
          $('#refreshLbBtn').click();
        }else{
          claimStatus.textContent='No points awarded.';
        }
      }catch(e){claimStatus.textContent='Claim failed';alert(e.message);}
    };

    // ---- Leaderboard ----
    async function refreshLeaderboard(){
      const lb=$('#lbTableBody'),lbStatus=$('#lbStatus'),lbUpdated=$('#lbUpdated');
      lbStatus.textContent='Loading…';
      try{
        const r=await fetch('/.netlify/functions/leaderboard');
        const d=await r.json();
        if(d.ok&&Array.isArray(d.entries)){
          lb.innerHTML=d.entries.map((x,i)=>`<tr><td>${i+1}</td><td>${x[0].slice(0,6)}…${x[0].slice(-4)}</td><td>${x[1]}</td></tr>`).join('');
          lbUpdated.textContent='Updated '+new Date().toLocaleTimeString();
          lbStatus.textContent='';
        }else lbStatus.textContent='No data';
      }catch(e){lbStatus.textContent='Leaderboard error';}
    }
    $('#refreshLbBtn').onclick=refreshLeaderboard;
    refreshLeaderboard();
  </script>
</body>
</html>
