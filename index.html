<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DreamPlay Personal Natural Resources (PNR) Digital Miner</title>
  <meta name="description" content="DreamPlay PNR Digital Miner — earn OOM points daily on Polygon." />

  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon-180.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon-512.png">

  <style>
    :root {
      --card-bg:#fff;
      --card-border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --link:#6b46c1;
      --accent:#6b46c1;
      --accent-soft:#f5f3ff;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color:var(--text);
      background:#f8fafc;
    }
    .container { max-width:980px; margin:0 auto; padding:20px; }
    .row { display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; }
    .card {
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:12px;
      padding:16px;
      margin-top:16px;
      box-shadow:0 2px 8px rgba(0,0,0,.04);
    }
    h1 { margin:0; font-size:1.3rem; }
    h2 { margin:.25rem 0 .75rem; font-size:1.1rem; }
    h3 { margin:.25rem 0 .5rem; font-size:1rem; }
    button {
      padding:10px 16px;
      border:none;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      font-size:.95rem;
    }
    .btn-primary { background:#6b46c1; color:#fff; }
    .btn-green { background:#22c55e; color:#fff; }
    .btn-blue { background:#3b82f6; color:#fff; }
    .btn-soft {
      background:#f3f4f6;
      color:#111827;
      border:1px solid #e5e7eb;
    }
    .soft {
      background:#f3f4f6;
      border-radius:8px;
      padding:6px 10px;
    }
    .small { font-size:.9rem; }
    .muted { color:var(--muted); }
    a { color:var(--link); text-decoration:none; }
    a.badge-link {
      border:1px solid #d6bcfa;
      background:#f5f3ff;
      padding:6px 10px;
      border-radius:999px;
      font-weight:600;
    }
    .badge {
      display:inline-block;
      padding:3px 8px;
      border:1px solid #dbeafe;
      background:#eff6ff;
      border-radius:999px;
      font-size:.8rem;
    }
    input, select, textarea {
      padding:10px;
      border:1px solid #cbd5e1;
      border-radius:10px;
      font-size:.95rem;
      width:100%;
      max-width:100%;
    }
    input::placeholder,
    textarea::placeholder {
      color:#9ca3af;
    }
    .grow { flex:1 1 auto; min-width:240px; }
    textarea { min-height:80px; resize:vertical; }

    table { width:100%; border-collapse:collapse; }
    thead th {
      text-align:left;
      border-bottom:1px solid var(--card-border);
      padding:6px 4px;
      font-size:.85rem;
      color:#6b7280;
    }
    tbody td {
      border-bottom:1px solid #f1f5f9;
      padding:8px 4px;
      font-size:.9rem;
    }
    .ok { color:#16a34a; }
    .bad { color:#dc2626; }
    .warn { color:#b45309; }

    .videoWrap { position:relative; display:inline-block; max-width:100%; }
    .videoWrap iframe { max-width:100%; border-radius:10px; }
    .videoCover {
      position:absolute;
      inset:0;
      cursor:pointer;
      border-radius:10px;
    }
    .copy-btn {
      padding:6px 10px;
      border-radius:8px;
      background:#eef2ff;
      border:1px solid #c7d2fe;
      font-weight:600;
      cursor:pointer;
    }
    .pill {
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:.8rem;
    }
    .pill-green { background:#ecfdf5; color:#166534; border:1px solid #bbf7d0; }
    .pill-grey { background:#f3f4f6; color:#4b5563; border:1px solid #e5e7eb; }

    @media (max-width:640px){
      header.row { align-items:flex-start; }
      h1 { font-size:1.1rem; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>

<body>
<div class="container">
  <header class="row" style="justify-content:space-between; border-bottom:1px solid #e5e7eb; padding-bottom:10px; margin-bottom:10px;">
    <div class="row">
      <img src="/assets/dreamplay-logo.png" alt="DreamPlay" style="height:48px;width:auto;border-radius:10px;margin-right:.5rem" onerror="this.style.display='none'">
      <div>
        <h1>DreamPlay Personal Natural Resources (PNR) Digital Miner</h1>
        <div class="muted small">Your sponsor must be an Anchor or someone who has launched via the DreamPlay Token Factory.</div>
      </div>
    </div>
    <a class="badge-link" href="/dgnn/">Go to DGNN →</a>
  </header>

  <!-- Wallet -->
  <section class="card">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <div class="row">
        <button id="connectBtn" class="btn-primary">Connect with MetaMask</button>
        <!-- Mobile deep link into MetaMask app -->
        <a
          id="openInMM"
          href="https://metamask.app.link/dapp/funny-babka-df9849.netlify.app/"
          style="display:none;padding:10px 16px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;text-decoration:none;font-weight:600;"
        >
          Open in MetaMask (mobile)
        </a>
      </div>
      <span id="connStatus" class="small">Not connected</span>
    </div>
    <div class="row" style="margin-top:.5rem">
      <span class="badge">Polygon • Chain 137</span>
      <span class="badge">JS loaded</span>
    </div>
    <div id="pointsToday" class="small muted" style="margin-top:.5rem"></div>
  </section>

  <!-- Belief Chain & Sponsor -->
  <section class="card">
    <h2>Belief Chain & Sponsor</h2>
    <p class="small muted">
      To earn OOM points with the PNR Digital Miner, you must accept the DreamPlay Core Values (Certificate of Belief)
      and choose a sponsor (Anchor or launched member). This is stored once in the on-chain Sponsor Registry and used by all DreamPlay apps.
    </p>

    <div class="soft small" id="cobTextBox" style="margin-top:.5rem; max-height:160px; overflow:auto;">
      <strong>Certificate of Belief (COB)</strong>
      <div id="cobTextContent" style="margin-top:.25rem;">
        Loading Core Values…
      </div>
    </div>

    <div class="row" style="margin-top:.75rem; align-items:center;">
      <button id="acceptCobBtn" class="btn-green">Accept Core Values (COB)</button>
      <span id="cobStatus" class="small muted">Status: unknown</span>
    </div>

    <div style="margin-top:1rem;">
      <h3>My Sponsor (Anchor or Launched Member)</h3>
      <p class="small muted" style="margin-bottom:.4rem;">
        Once set, your sponsor is shared across Token Factory, Store, PNR, and other DreamPlay apps.
      </p>
      <div class="row" style="gap:.5rem;">
        <input id="sponsorInput" class="grow" placeholder="Sponsor address (0x…)" />
        <button id="setSponsorBtn" class="btn-soft">Set Sponsor (once)</button>
      </div>
      <div class="row" style="margin-top:.4rem; gap:.5rem;">
        <span id="sponsorChainStatus" class="small muted">Sponsor: (not set)</span>
      </div>
      <div class="row" style="margin-top:.25rem;">
        <span id="beliefMemberStatus" class="small pill pill-grey">
          Belief Chain status: unknown
        </span>
      </div>
    </div>
  </section>

  <!-- PNR Digital Miner -->
  <section class="card">
    <h2>PNR Digital Miner</h2>
    <p class="small muted">
      Log real actions that grow people, stories, and liquidity. Points are recorded by the DreamPlay backend,
      but your sponsor relationship is enforced on-chain via the Sponsor Registry.
    </p>

    <div style="margin-top:.75rem;">
      <label for="actionSelect" class="small muted">Action Type</label>
      <select id="actionSelect" style="margin-top:.25rem;">
        <option value="RECRUIT_MEMBER">Recruit a New Member (+20 pts)</option>
        <option value="COACH_MEMBER">Coach a New Member (+15 pts)</option>
        <option value="CREATE_CONTENT">Create Content (+10 pts)</option>
        <option value="SHARE_CONTENT">Share Content (+5 pts)</option>
        <option value="VERIFY_ID">Verify ID (+15 pts)</option>
        <option value="QUALITY_CONTROL">Quality Control (+5 pts)</option>
        <option value="FINLIT_LESSON">Financial Literacy Lesson (+15 pts)</option>
        <option value="REPORTER">Reporter (+15 pts)</option>
        <option value="DREAMCASTER">DreamCaster (+15 pts)</option>
        <option value="VOTE">Vote (+10 pts)</option>
        <option value="BELIEF_CHAIN">Join the Belief Chain (+20 pts)</option>
      </select>
    </div>

    <div style="margin-top:.75rem;">
      <label for="notesInput" class="small muted">Notes (optional)</label>
      <textarea id="notesInput" placeholder="Add any context so your leader or verifier can understand this action…"></textarea>
    </div>

    <div class="row" style="margin-top:.75rem; gap:.75rem;">
      <button id="logBtn" class="btn-green">Log Action &amp; Earn OOM</button>
      <span id="actorStatus" class="small"></span>
    </div>

    <div style="margin-top:1rem;">
      <h3>Points &amp; Limits</h3>
      <p class="small muted">
        Each action type has a fixed OOM point value. Daily cap is <strong>100 points per wallet</strong> across all actions.
        The backend enforces caps and validation.
      </p>
      <ul class="small muted" style="margin-top:.25rem; padding-left:1.15rem;">
        <li>Recruit: 20 pts</li>
        <li>Coach: 15 pts</li>
        <li>Create content: 10 pts</li>
        <li>Share content: 5 pts</li>
        <li>Verify ID: 15 pts</li>
        <li>QC / verify: 5 pts</li>
        <li>Financial literacy: 15 pts</li>
        <li>Reporter / DGNN: 15 pts</li>
        <li>DreamCaster: 15 pts</li>
        <li>Vote: 10 pts</li>
      </ul>
    </div>
  </section>

  <!-- Daily Video -->
  <section class="card">
    <h2>Daily Watch Action</h2>
    <p class="small muted">
      After you’ve watched the daily video, click the button below to claim your daily “watch route” points.
      This uses the same backend as your other PNR actions.
    </p>

    <div class="row">
      <div class="videoWrap">
        <iframe
          id="video"
          width="560"
          height="315"
          src="https://www.youtube.com/embed/olQrCfkvbGw?rel=0&enablejsapi=1&playsinline=1"
          title="YouTube video player"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          referrerpolicy="strict-origin-when-cross-origin"
          allowfullscreen
        ></iframe>
        <div id="videoCover" class="videoCover" title="Click to start watching"></div>
      </div>
    </div>

    <div class="row" style="margin-top:.75rem;">
      <button id="claimBtn" class="btn-blue" disabled>I Watched Today (Claim Daily)</button>
      <button id="checkClaimBtn" class="btn-soft">Check Claim Status</button>
      <span id="claimStatus" class="small">Watch at least <b>60s and 50%</b> to enable claim.</span>
    </div>
    <div class="row" style="margin-top:.25rem;">
      <span id="claimDebug" class="small muted"></span>
    </div>
  </section>

  <!-- Verifier -->
  <section class="card">
    <h2>Verifier Tools</h2>
    <div class="row">
      <button id="checkFunctions" class="btn-soft">Check Functions</button>
      <button id="getNonce" class="btn-soft">Get Nonce</button>
      <span id="verifyStatus" class="small"></span>
    </div>
  </section>

  <!-- Leaderboard -->
  <section class="card">
    <h2>Leaderboard</h2>
    <div class="row">
      <button id="refreshLbBtn" class="btn-soft">Refresh</button>
      <span id="lbStatus" class="small"></span>
      <span id="lbUpdated" class="small" style="margin-left:.5rem"></span>
    </div>
    <table style="margin-top:.5rem;">
      <thead>
        <tr><th>#</th><th>Address</th><th>Points</th></tr>
      </thead>
      <tbody id="lbTableBody">
        <tr><td>—</td><td>—</td><td>—</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Post Point Board -->
  <section class="card">
    <h2>Post Point Board (from my actions)</h2>
    <div class="row" style="gap:.5rem">
      <button id="ppbRefresh" class="btn-soft">Build My Post Point Board</button>
      <span id="ppbStatus" class="small"></span>
    </div>

    <div class="row" style="margin-top:.5rem">
      <div class="soft small">Level totals (applied to my awarded points)</div>
    </div>
    <table style="margin-top:.5rem">
      <thead><tr><th>Level</th><th>%</th><th>Points</th></tr></thead>
      <tbody id="ppbLevels">
        <tr><td>—</td><td>—</td><td>—</td></tr>
      </tbody>
    </table>

    <div class="row" style="margin-top:1rem">
      <div class="soft small">Who earned from my efforts</div>
    </div>
    <table>
      <thead><tr><th>#</th><th>Upline</th><th>Points</th><th></th></tr></thead>
      <tbody id="ppbWallets">
        <tr><td>—</td><td>—</td><td>—</td><td></td></tr>
      </tbody>
    </table>
  </section>

  <section style="margin:18px 0 32px;">
    <p class="small muted">
      <strong>Need Help?</strong><br/>
      1. Connect wallet on Polygon (137).<br/>
      2. Accept the Core Values (COB).<br/>
      3. Set your sponsor once (Anchor or launched member).<br/>
      4. Log real actions in the PNR Miner and keep the rhythm.
    </p>
  </section>
</div>

<script>
(function(){
  const CHAIN_ID_HEX = "0x89"; // Polygon
  const ZERO = "0x0000000000000000000000000000000000000000";

  const POLYGON_PARAMS = {
    chainId: CHAIN_ID_HEX,
    chainName: "Polygon Mainnet",
    nativeCurrency: { name:"MATIC", symbol:"MATIC", decimals:18 },
    rpcUrls: [window.POLYGON_PUBLIC_RPC || "https://rpc.ankr.com/polygon"],
    blockExplorerUrls: ["https://polygonscan.com"]
  };

  // Sponsor Registry
  const REGISTRY_ADDRESS = "0xAf31D65A5B582258655F246F3098aE003e784AC1";
  const REGISTRY_ABI = [
    "function cobText() view returns (string)",
    "function hasAcceptedCOB(address) view returns (bool)",
    "function acceptCOB()",
    "function setSponsor(address)",
    "function sponsorOf(address) view returns (address)",
    "function isBeliefChainMember(address) view returns (bool)",
    "function isValidSponsor(address) view returns (bool)"
  ];

  const $ = (s)=>document.querySelector(s);
  const short = (a)=> a ? a.slice(0,6)+"…"+a.slice(-4) : "";
  const isAddr = (x)=> /^0x[a-fA-F0-9]{40}$/i.test(x || "");

  function setStatus(t){
    const el=$("#connStatus");
    if(el) el.textContent=t;
  }
  function setPointsToday(t){
    const el=$("#pointsToday");
    if(el) el.textContent=t || "";
  }

  async function getJSON(url){
    const r=await fetch(url,{headers:{accept:"application/json"}});
    const d=await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d?.error || JSON.stringify(d));
    return d;
  }
  async function postJSON(url,body){
    const r=await fetch(url,{
      method:"POST",
      headers:{"content-type":"application/json",accept:"application/json"},
      body:JSON.stringify(body)
    });
    const d=await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d?.error || JSON.stringify(d));
    return d;
  }

  // --- Mobile + MetaMask deep link ---
  function isMobile() {
    return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || "");
  }
  function showOpenInMMIfNeeded() {
    const link = document.getElementById("openInMM");
    if (!link) return;
    if (isMobile() && typeof window.ethereum === "undefined") {
      link.style.display = "inline-block";
    } else {
      link.style.display = "none";
    }
  }
  document.addEventListener("DOMContentLoaded", showOpenInMMIfNeeded);

  const state = {
    wallet:"",
    provider:null,
    signer:null,
    registry:null,
    cobAccepted:false,
    sponsor:ZERO,
    beliefMember:false
  };

  async function ensureEthereum(){
    if(!window.ethereum){
      alert("On mobile, open this page inside the MetaMask app.\nTap the 'Open in MetaMask (mobile)' button.");
      throw new Error("No ethereum provider");
    }
    return window.ethereum;
  }

  async function ensurePolygon(eth){
    const id = await eth.request({ method:"eth_chainId" });
    if (id !== CHAIN_ID_HEX){
      try {
        await eth.request({
          method:"wallet_switchEthereumChain",
          params:[{chainId:CHAIN_ID_HEX}]
        });
      } catch(e){
        if(e && e.code===4902){
          await eth.request({ method:"wallet_addEthereumChain", params:[POLYGON_PARAMS] });
        } else {
          throw e;
        }
      }
    }
  }

  async function initProvider(){
    if(!window.ethereum) return;
    const provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    const signer = provider.getSigner();
    const registry = new ethers.Contract(REGISTRY_ADDRESS, REGISTRY_ABI, signer);
    state.provider = provider;
    state.signer = signer;
    state.registry = registry;
  }

  async function getTodayTotal(){
    if (!isAddr(state.wallet)) return null;
    const d = await getJSON(`/.netlify/functions/claim-daily?wallet=${state.wallet}&mode=status`);
    return (typeof d?.dayTotal === "number") ? d.dayTotal : null;
  }

  async function refreshPoints(){
    try {
      const tot = await getTodayTotal();
      if (typeof tot === "number"){
        setPointsToday(`Points today: ${tot} / 100`);
      }
    } catch(_) {}
  }

  async function loadCobAndSponsorState(){
    const cobStatus = $("#cobStatus");
    const sponsorStatus = $("#sponsorChainStatus");
    const beliefStatus = $("#beliefMemberStatus");
    const cobBoxText = $("#cobTextContent");

    if(!state.registry || !isAddr(state.wallet)) return;

    try{
      // COB text
      if (cobBoxText){
        try{
          const txt = await state.registry.cobText();
          cobBoxText.textContent = txt || cobBoxText.textContent;
        } catch(_){}
      }

      const [cob, sponsor, bc] = await Promise.all([
        state.registry.hasAcceptedCOB(state.wallet),
        state.registry.sponsorOf(state.wallet),
        state.registry.isBeliefChainMember(state.wallet)
      ]);

      state.cobAccepted = cob;
      state.sponsor = sponsor;
      state.beliefMember = bc;

      if (cobStatus){
        cobStatus.textContent = cob ? "Status: COB accepted ✅" : "Status: COB not accepted";
        cobStatus.className = cob ? "small ok" : "small bad";
      }

      if (sponsorStatus){
        sponsorStatus.textContent = sponsor && sponsor !== ZERO
          ? `Sponsor: ${sponsor}`
          : "Sponsor: (not set)";
      }

      if (beliefStatus){
        if (bc){
          beliefStatus.textContent = "Belief Chain Member • COB accepted + sponsor set";
          beliefStatus.className = "small pill pill-green";
        } else {
          beliefStatus.textContent = "Not yet a Belief Chain member";
          beliefStatus.className = "small pill pill-grey";
        }
      }

      // If sponsor already set, prefill the input for display only
      const spInput = $("#sponsorInput");
      if (spInput && sponsor !== ZERO){
        spInput.value = sponsor;
      }

    } catch(e){
      console.warn("Error loading COB/sponsor state", e);
    }
  }

  async function connect(){
    const eth = await ensureEthereum();
    await ensurePolygon(eth);

    const accts = await eth.request({ method:"eth_requestAccounts" });
    if(!accts || !accts[0]) throw new Error("No account");

    state.wallet = accts[0];
    setStatus(`Connected: ${short(state.wallet)} • chain 137`);

    await initProvider();
    await loadCobAndSponsorState();
    await refreshPoints();
  }

  $("#connectBtn")?.addEventListener("click", async () => {
    try { await connect(); } catch(e){ console.warn(e); }
  });

  // Auto-detect existing account (desktop / MM browser)
  (async ()=>{
    try{
      if (window.ethereum){
        const accts = await window.ethereum.request({ method:"eth_accounts" });
        const acct = Array.isArray(accts) && accts[0] ? accts[0] : "";
        if (acct){
          state.wallet = acct;
          setStatus(`Connected: ${short(acct)} • chain 137`);
          await initProvider();
          await loadCobAndSponsorState();
          await refreshPoints();
        } else {
          setStatus("Not connected");
        }
      }
    } catch(_) {}
  })();

  // React to account / chain changes
  if (window.ethereum) {
    window.ethereum.on?.("accountsChanged", async (accs)=>{
      const a = accs && accs[0];
      if (a) {
        state.wallet = a;
        setStatus(`Connected: ${short(a)} • chain 137`);
        await initProvider();
        await loadCobAndSponsorState();
        await refreshPoints();
      } else {
        state.wallet = "";
        setStatus("Not connected");
        setPointsToday("");
      }
    });
    window.ethereum.on?.("chainChanged", (_id)=>{
      // safest: reload on chain change
      location.reload();
    });
  }

  // --- COB button ---
  $("#acceptCobBtn")?.addEventListener("click", async ()=>{
    if (!state.registry || !isAddr(state.wallet)){
      alert("Connect wallet first.");
      return;
    }
    const cobStatus = $("#cobStatus");
    try{
      cobStatus.textContent = "Submitting COB transaction…";
      const tx = await state.registry.acceptCOB();
      await tx.wait();
      cobStatus.textContent = "Status: COB accepted ✅";
      cobStatus.className = "small ok";
      state.cobAccepted = true;
      await loadCobAndSponsorState();
    }catch(e){
      console.error(e);
      cobStatus.textContent = "Error accepting COB (check wallet).";
      cobStatus.className = "small bad";
      alert(e?.message || "COB transaction failed");
    }
  });

  // --- Set Sponsor button (uses registry; sponsor stored once) ---
  $("#setSponsorBtn")?.addEventListener("click", async ()=>{
    if (!state.registry || !isAddr(state.wallet)){
      alert("Connect wallet first.");
      return;
    }
    const sInput = $("#sponsorInput");
    const sponsorRaw = (sInput?.value || "").trim();
    const sponsorStatus = $("#sponsorChainStatus");

    if (!isAddr(sponsorRaw)){
      sponsorStatus.textContent = "Invalid address format.";
      sponsorStatus.className = "small bad";
      alert("Sponsor must be a valid 0x address.");
      return;
    }
    if (!state.cobAccepted){
      alert("You must accept the Core Values (COB) first.");
      return;
    }

    try{
      sponsorStatus.textContent = "Checking sponsor validity…";
      const valid = await state.registry.isValidSponsor(sponsorRaw);
      if (!valid){
        sponsorStatus.textContent = "Sponsor is not an Anchor or launched member.";
        sponsorStatus.className = "small bad";
        alert("Sponsor must be an Anchor or someone who has launched.");
        return;
      }

      sponsorStatus.textContent = "Submitting sponsor transaction…";
      sponsorStatus.className = "small muted";
      const tx = await state.registry.setSponsor(sponsorRaw);
      await tx.wait();
      sponsorStatus.textContent = `Sponsor: ${sponsorRaw}`;
      sponsorStatus.className = "small ok";
      state.sponsor = sponsorRaw;
      await loadCobAndSponsorState();
    }catch(e){
      console.error(e);
      sponsorStatus.textContent = "Error setting sponsor (see wallet).";
      sponsorStatus.className = "small bad";
      alert(e?.message || "Sponsor transaction failed");
    }
  });

  // --- Log action (uses sponsor from registry, NOT typed each time) ---
  $("#logBtn")?.addEventListener("click", async ()=>{
    if (!isAddr(state.wallet)) {
      alert("Connect wallet first");
      return;
    }
    if (!state.beliefMember){
      alert("You must accept COB and set a valid sponsor before logging actions.");
      return;
    }

    const id = $("#actionSelect")?.value || "RECRUIT_MEMBER";
    const notes = ($("#notesInput")?.value || "").trim();

    const ptsMap = {
      RECRUIT_MEMBER:20,
      COACH_MEMBER:15,
      CREATE_CONTENT:10,
      SHARE_CONTENT:5,
      VERIFY_ID:15,
      QUALITY_CONTROL:5,
      FINLIT_LESSON:15,
      REPORTER:15,
      DREAMCASTER:15,
      VOTE:10,
      BELIEF_CHAIN:20
    };
    const pts = ptsMap[id] || 0;

    const st = $("#actorStatus");
    st.textContent = "Logging…";

    try{
      // Read sponsor from registry as source of truth
      const sponsor = await state.registry.sponsorOf(state.wallet);
      if (!sponsor || sponsor === ZERO){
        st.textContent = "You do not have a sponsor set.";
        alert("You must set a sponsor first.");
        return;
      }

      const out = await postJSON("/.netlify/functions/log-action", {
        wallet: state.wallet,
        action: id,
        points: pts,
        sponsor,
        notes
      });

      const maxed = out.capped || (typeof out.dayTotal === "number" && out.dayTotal >= 100);
      if (out.awarded > 0){
        st.textContent = `Logged ${id} (+${out.awarded}) • Total ${out.dayTotal}`;
        try{
          window.confetti && window.confetti({
            spread:60,
            particleCount:80,
            origin:{y:0.7}
          });
        }catch(_) {}
      } else if (maxed){
        st.textContent = "Max Daily Pts Reached (100).";
      } else {
        st.textContent = "No points awarded.";
      }

      await refreshPoints();
      $("#refreshLbBtn")?.click();
    } catch(e){
      console.error(e);
      st.textContent = "Log failed";
      alert(e?.message || e);
    }
  });

  // --- Daily video gate + claim ---
  let player, duration=0, watched=0, playing=false, apiReady=false, started=false;
  const cover = $("#videoCover");
  if (cover){
    cover.addEventListener("click", ()=>{
      started = true;
      cover.style.display = "none";
    });
  }

  window.onYouTubeIframeAPIReady = function(){
    const dbg=$("#claimDebug");
    apiReady=true;
    if(dbg) dbg.textContent="YouTube API ready";
    try{
      player = new YT.Player('video',{
        events:{
          onReady:(e)=>{
            try{ duration = e.target.getDuration() || 0; } catch(_){ duration = 0; }
            updateGate();
          },
          onStateChange:(e)=>{
            if (e.data===YT.PlayerState.PLAYING){
              playing=true;
            } else {
              if (playing){
                playing=false;
                updateGate();
              }
            }
          }
        }
      });
    }catch(e){
      if(dbg) dbg.textContent="YT init error: "+(e?.message||e);
    }
  };

  setInterval(()=>{
    if (started && playing){
      watched += 0.5;
      updateGate();
    }
  }, 500);

  function eligibleNow(){
    if (!started) return false;
    if (apiReady && player){
      let pct=0;
      try{
        pct = duration ? (player.getCurrentTime()/Math.max(duration,1)) : 0;
      }catch(_){}
      return (watched >= 60) && (pct >= 0.5);
    }
    return watched >= 60;
  }

  function updateGate(){
    const btn=$("#claimBtn"), status=$("#claimStatus");
    if(!btn || !status) return;
    const ok = eligibleNow();
    btn.disabled = !ok;
    let pct=0;
    try{
      pct = player ? (player.getCurrentTime()/Math.max(duration||1,1)) : 0;
    }catch(_){}
    status.textContent = ok
      ? "Eligible to claim ✅"
      : `Watch at least 60s and 50% — watched ${Math.floor(watched)}s (${Math.floor(pct*100)}%)`;
  }

  // Check Claim Status
  $("#checkClaimBtn")?.addEventListener("click", async () => {
    try{
      if (!isAddr(state.wallet)) {
        alert("Connect wallet first");
        return;
      }
      const j = await getJSON(`/.netlify/functions/claim-daily?wallet=${state.wallet}&mode=status`);
      const dbg = $("#claimDebug");
      const status = $("#claimStatus");
      if (dbg) dbg.textContent = "status: " + JSON.stringify(j);
      if (j.alreadyClaimed) {
        const mins = Math.ceil((j.nextEligibleMs || 0) / 60000);
        status.textContent = `Already claimed — try again in ~${mins} min. (today ${j.dayTotal})`;
      } else {
        status.textContent = `Eligible? ${!j.alreadyClaimed} • Today ${j.dayTotal}`;
      }
    } catch(e){
      alert(e?.message||e);
    }
  });

  // Claim Daily
  $("#claimBtn")?.addEventListener("click", async () => {
    const status = $("#claimStatus");
    const dbg = $("#claimDebug");
    const btn = $("#claimBtn");
    try {
      if (!window.ethereum) return alert("Connect wallet first");
      const accounts = await window.ethereum.request({ method:"eth_accounts" });
      const wallet = (accounts && accounts[0]) || "";
      if (!isAddr(wallet)) return alert("Connect wallet first");
      if (btn.disabled) return;

      btn.disabled = true;
      status.textContent = "Claiming…";

      const res = await fetch("/.netlify/functions/claim-daily", {
        method: "POST",
        headers: { "content-type": "application/json", accept: "application/json" },
        body: JSON.stringify({
          wallet,
          actionId: "daily-video",
          meta: { watchedSeconds: Math.floor(watched) }
        })
      });

      let data = {};
      try { data = await res.json(); } catch {}
      if (dbg) dbg.textContent = "resp: " + JSON.stringify(data);

      if (!res.ok) {
        status.textContent = "Claim failed";
        alert(data?.error || JSON.stringify(data));
        btn.disabled = false;
        return;
      }

      if (data.alreadyClaimed) {
        const mins = Math.ceil((data.nextEligibleMs || 0) / 60000);
        status.textContent = `Already claimed — try again in ~${mins} min.`;
      } else if (data.capped || (typeof data.dayTotal === "number" && data.dayTotal >= 100)) {
        status.textContent = "Max Daily Pts Reached (100).";
      } else if (data.pointsAwarded > 0) {
        status.textContent = `Claimed! +${data.pointsAwarded} (today ${data.dayTotal})`;
        try {
          window.confetti && window.confetti({
            spread: 70,
            particleCount: 120,
            origin: { y: 0.6 }
          });
        } catch(_) {}
      } else {
        status.textContent = "No points awarded.";
      }

      await refreshPoints();
      $("#refreshLbBtn")?.click();
    } catch (e) {
      status.textContent = "Claim failed";
      alert(e?.message || e);
    } finally {
      // require re-watch for next claim
      btn.disabled = true;
    }
  });

  // --- Verifier buttons ---
  $("#checkFunctions")?.addEventListener("click", async ()=>{
    const el=$("#verifyStatus");
    el.textContent="Calling blobs-selftest…";
    try{
      const r=await fetch("/.netlify/functions/blobs-selftest",{headers:{accept:"application/json"}});
      el.textContent="blobs-selftest: "+(await r.text()).slice(0,140);
    } catch(e){
      el.textContent="blobs-selftest failed: "+(e?.message||e);
    }
  });

  $("#getNonce")?.addEventListener("click", async ()=>{
    const el=$("#verifyStatus");
    el.textContent="Requesting nonce…";
    try{
      const r=await fetch("/.netlify/functions/nonce",{headers:{accept:"application/json"}});
      el.textContent="nonce: "+(await r.text()).slice(0,140);
    } catch(e){
      el.textContent="nonce failed: "+(e?.message||e);
    }
  });

  // --- Leaderboard ---
  async function refreshLeaderboard(){
    const body=$("#lbTableBody"), lbStatus=$("#lbStatus"), lbUpdated=$("#lbUpdated");
    lbStatus.textContent="Loading…";
    try{
      const data = await getJSON("/.netlify/functions/leaderboard");
      if (data.ok && Array.isArray(data.entries)){
        body.innerHTML =
          data.entries.map((row,i)=>(
            `<tr>
              <td>${i+1}</td>
              <td title="${row[0]}">${row[0].slice(0,6)}…${row[0].slice(-4)}</td>
              <td>${row[1]}</td>
            </tr>`
          )).join("") ||
          `<tr><td>—</td><td>—</td><td>—</td></tr>`;
        lbUpdated.textContent="Updated "+new Date().toLocaleTimeString();
        lbStatus.textContent="";
      } else {
        lbStatus.textContent = data.error || "No data";
      }
    }catch(e){
      lbStatus.textContent="Leaderboard error";
    }
  }
  $("#refreshLbBtn")?.addEventListener("click", refreshLeaderboard);
  refreshLeaderboard();

  // --- Post Point Board ---
  async function buildPostPointBoard(){
    const status = $("#ppbStatus");
    const tbodyLv = $("#ppbLevels");
    const tbodyW = $("#ppbWallets");
    try {
      if (!window.ethereum) throw new Error("Connect wallet first");
      const accts = await window.ethereum.request({ method:"eth_accounts" });
      const wallet = (accts && accts[0]) || "";
      if (!isAddr(wallet)) throw new Error("Connect wallet first");

      status.textContent = "Building…";
      const r = await fetch(`/.netlify/functions/post-board?wallet=${wallet}`, {
        headers:{accept:"application/json"}
      });
      const data = await r.json().catch(()=>({}));

      if (!data?.ok) throw new Error(data?.error || "Post board failed");

      if (Array.isArray(data.levels) && data.levels.length){
        tbodyLv.innerHTML = data.levels.map(l => (
          `<tr>
            <td>L${l.level}</td>
            <td>${l.pct}%</td>
            <td>${Number(l.points).toFixed(2)}</td>
          </tr>`
        )).join("");
      } else {
        tbodyLv.innerHTML = `<tr><td>—</td><td>—</td><td>—</td></tr>`;
      }

      if (Array.isArray(data.totals) && data.totals.length){
        const filtered = data.totals.filter(row => (row && row[0] && row[0].toLowerCase() !== ZERO));
        tbodyW.innerHTML = filtered.map((row,i)=>{
          const addr = row[0];
          const pts = Number(row[1]).toFixed(2);
          const label = addr.slice(0,6)+"…"+addr.slice(-4);
          return `<tr>
            <td>${i+1}</td>
            <td title="${addr}">${label}</td>
            <td>${pts}</td>
            <td><button class="copy-btn" data-copy="${addr}">Copy</button></td>
          </tr>`;
        }).join("") || `<tr><td>—</td><td>—</td><td>—</td><td></td></tr>`;
      } else {
        tbodyW.innerHTML = `<tr><td>—</td><td>—</td><td>—</td><td></td></tr>`;
      }

      tbodyW.querySelectorAll("button[data-copy]").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          const v = e.currentTarget.getAttribute("data-copy") || "";
          try {
            await navigator.clipboard.writeText(v);
            const prev = e.currentTarget.textContent;
            e.currentTarget.textContent = "Copied!";
            setTimeout(()=>{ e.currentTarget.textContent = prev; }, 900);
          } catch {
            alert("Copy failed");
          }
        });
      });

      status.textContent = `Built from ${data.actions} action(s).`;
    } catch (e) {
      status.textContent = e?.message || "Error";
    }
  }
  $("#ppbRefresh")?.addEventListener("click", buildPostPointBoard);
})();
</script>
</body>
</html>

